# ProofStateå†…å­˜ç®¡ç†æ”¹é©

## æ¦‚è¿°

æœ¬æ¬¡æ”¹é©å®ç°äº†ProofStateçš„è‡ªåŠ¨å†…å­˜ç®¡ç†ï¼Œé€šè¿‡LRUç¼“å­˜æœºåˆ¶é™åˆ¶å†…å­˜ä¸­æœ€å¤šç»´æŠ¤20ä¸ªçŠ¶æ€ï¼Œå¹¶æä¾›é€æ˜çš„çŠ¶æ€é‡å»ºåŠŸèƒ½ã€‚

## æ ¸å¿ƒç»„ä»¶

### 1. ProofStateCache (`proofstate_cache.py`)

**ä¸»è¦åŠŸèƒ½:**
- ç»´æŠ¤æœ€å¤š20ä¸ªProofStateçš„LRUç¼“å­˜
- è‡ªåŠ¨è°ƒç”¨`RemoveProofState`å‘½ä»¤æ¸…ç†å†…å­˜
- é€æ˜çš„çŠ¶æ€é‡å»ºæœºåˆ¶
- è¯¦ç»†çš„ç»Ÿè®¡ç›‘æ§

**æ ¸å¿ƒæ¥å£:**
```python
cache = ProofStateCache(max_states=20)
cache.set_lean_server(lean_server)

# æ³¨å†Œæ–°çŠ¶æ€
cache.register_state(state_id, parent_id=None, tactic=None, is_root=False)

# ç¡®ä¿çŠ¶æ€å¯ç”¨ï¼ˆæ ¸å¿ƒæ¥å£ï¼‰
available_state_id = cache.ensure_state_available(state_id)

# è·å–ç»Ÿè®¡ä¿¡æ¯
info = cache.get_cache_info()
```

### 2. é›†æˆåˆ°MinimalLeanProofStepIntegrator

**è‡ªåŠ¨é›†æˆåŠŸèƒ½:**
- åˆå§‹åŒ–æ—¶åˆ›å»ºProofStateCacheå®ä¾‹
- ProofStepæ‰§è¡Œå‰è‡ªåŠ¨ç¡®ä¿çŠ¶æ€å¯ç”¨
- ProofStepæ‰§è¡Œåè‡ªåŠ¨æ³¨å†Œæ–°ç”Ÿæˆçš„çŠ¶æ€
- æœåŠ¡å™¨å…³é—­æ—¶è‡ªåŠ¨æ¸…ç†ç¼“å­˜

**ä½¿ç”¨ç¤ºä¾‹:**
```python
integrator = MinimalLeanProofStepIntegrator()
integrator.initialize_lean_server()

# å†…å­˜ç®¡ç†å®Œå…¨é€æ˜ï¼Œæ— éœ€æ‰‹åŠ¨æ“ä½œ
result = integrator.test_tactic_on_proof_state(proof_state, tactic)

# è‡ªåŠ¨è¾“å‡ºç¼“å­˜ç»Ÿè®¡
integrator.shutdown_lean_server()
```

### 3. ç®€åŒ–çš„CleanNgramSearcher

**æ”¹è¿›å†…å®¹:**
- ç§»é™¤å¤æ‚çš„æœåŠ¡å™¨é‡å¯é€»è¾‘
- ç§»é™¤æ‰‹åŠ¨å†…å­˜ç®¡ç†ä»£ç 
- çŠ¶æ€ç¡®ä¿ç”±ProofStateCacheé€æ˜å¤„ç†
- ç®€åŒ–çš„é”™è¯¯å¤„ç†å’Œæ¢å¤æœºåˆ¶

## å·¥ä½œåŸç†

### çŠ¶æ€è®¿é—®æµç¨‹

1. **è°ƒç”¨** `ensure_state_available(state_id)`
2. **æ£€æŸ¥ç¼“å­˜** - å¦‚æœçŠ¶æ€åœ¨å†…å­˜ä¸­ï¼Œç›´æ¥è¿”å›
3. **é€’å½’é‡å»º** - å¦‚æœçŠ¶æ€ä¸åœ¨å†…å­˜ï¼š
   - æŸ¥æ‰¾çˆ¶çŠ¶æ€å’Œç”Ÿæˆç­–ç•¥
   - é€’å½’ç¡®ä¿çˆ¶çŠ¶æ€å¯ç”¨
   - ä½¿ç”¨ProofStepä»çˆ¶çŠ¶æ€é‡æ–°ç”Ÿæˆç›®æ ‡çŠ¶æ€
4. **æ³¨å†Œç¼“å­˜** - å°†æ–°çŠ¶æ€æ·»åŠ åˆ°ç¼“å­˜
5. **LRUæ¸…ç†** - å¦‚æœè¶…è¿‡å®¹é‡é™åˆ¶ï¼Œæ¸…ç†æœ€ä¹…æœªä½¿ç”¨çš„çŠ¶æ€

### å†…å­˜ç®¡ç†ç­–ç•¥

```
å†…å­˜çŠ¶æ€æµè½¬:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    è¶…è¿‡å®¹é‡    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    RemoveProofState    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ´»è·ƒçŠ¶æ€ â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ â”‚ LRUé€‰æ‹©  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ â”‚ å†…å­˜é‡Šæ”¾ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â†‘                                                        â”‚
     â”‚                        éœ€è¦æ—¶é‡æ–°ç”Ÿæˆ                     â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ä½¿ç”¨åœºæ™¯

### 1. è‡ªåŠ¨é€æ˜ä½¿ç”¨ï¼ˆæ¨èï¼‰

æœ€ç®€å•çš„æ–¹å¼æ˜¯ä»€ä¹ˆéƒ½ä¸ç”¨æ”¹å˜ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨å¤„ç†å†…å­˜ç®¡ç†ï¼š

```python
# åŸæœ‰ä»£ç ä¿æŒä¸å˜
integrator = MinimalLeanProofStepIntegrator()
result = integrator.enumerate_tactics_with_proof_states(...)
# å†…å­˜ç®¡ç†å®Œå…¨é€æ˜
```

### 2. ç›‘æ§å†…å­˜ä½¿ç”¨

```python
integrator = MinimalLeanProofStepIntegrator()
# ... æ‰§è¡Œæ“ä½œ ...

# è·å–ç¼“å­˜ç»Ÿè®¡
cache_info = integrator.proof_state_cache.get_cache_info()
print(f"ç¼“å­˜ä½¿ç”¨: {cache_info['cache_size']}/{cache_info['max_states']}")
print(f"å‘½ä¸­ç‡: {cache_info['hit_rate']:.1f}%")
```

### 3. è‡ªå®šä¹‰ç¼“å­˜å¤§å°

```python
integrator = MinimalLeanProofStepIntegrator()
# ä¿®æ”¹ç¼“å­˜å¤§å°ï¼ˆé»˜è®¤20ï¼‰
integrator.proof_state_cache.max_states = 30
```

## æ€§èƒ½ä¼˜åŠ¿

### å†…å­˜æ§åˆ¶
- **ä¹‹å‰**: æ— é™åˆ¶ProofStateå¢é•¿ï¼Œå¯èƒ½å¯¼è‡´å†…å­˜æ³„æ¼
- **ç°åœ¨**: ä¸¥æ ¼é™åˆ¶æœ€å¤š20ä¸ªçŠ¶æ€ï¼Œè‡ªåŠ¨æ¸…ç†

### æ™ºèƒ½é‡å»º
- **æŒ‰éœ€é‡å»º**: åªæœ‰è®¿é—®æ—¶æ‰é‡å»ºçŠ¶æ€
- **é€’å½’æ¢å¤**: è‡ªåŠ¨å¤„ç†çŠ¶æ€ä¾èµ–é“¾
- **ç¼“å­˜å‘½ä¸­**: é¢‘ç¹ä½¿ç”¨çš„çŠ¶æ€ä¿æŒåœ¨å†…å­˜ä¸­

### é€æ˜é›†æˆ
- **é›¶ä»£ç æ”¹åŠ¨**: ç°æœ‰ä»£ç æ— éœ€ä¿®æ”¹
- **è‡ªåŠ¨ç®¡ç†**: ç”Ÿå‘½å‘¨æœŸå®Œå…¨è‡ªåŠ¨åŒ–
- **è¯¦ç»†ç›‘æ§**: æä¾›å®Œæ•´çš„ç»Ÿè®¡ä¿¡æ¯

## æµ‹è¯•éªŒè¯

è¿è¡Œé›†æˆæµ‹è¯•ï¼š

```bash
python test_proofstate_memory_management.py
```

æµ‹è¯•å†…å®¹åŒ…æ‹¬ï¼š
1. åŸºæœ¬ç¼“å­˜åŠŸèƒ½
2. LRUæ¸…ç†æœºåˆ¶
3. Integratoré›†æˆ
4. çŠ¶æ€é‡å»ºé€»è¾‘
5. ç»Ÿè®¡åŠŸèƒ½

## æŠ€æœ¯ç»†èŠ‚

### ç¼“å­˜ç­–ç•¥
- **LRU (Least Recently Used)**: æ¸…ç†æœ€ä¹…æœªä½¿ç”¨çš„çŠ¶æ€
- **æ ¹çŠ¶æ€ä¿æŠ¤**: æ ‡è®°ä¸ºrootçš„çŠ¶æ€ä¸ä¼šè¢«æ¸…ç†
- **æ‰¹é‡æ¸…ç†**: ä¸€æ¬¡æ¸…ç†å¤šä¸ªçŠ¶æ€ä»¥å‡å°‘å¼€é”€

### çŠ¶æ€é‡å»º
```python
def ensure_state_available(state_id):
    if state_id in cache:
        return state_id  # ç¼“å­˜å‘½ä¸­
    
    # ç¼“å­˜æœªå‘½ä¸­ - é‡å»º
    parent_id, tactic = parent_map[state_id]
    parent = ensure_state_available(parent_id)  # é€’å½’
    new_state = run_proofstep(parent, tactic)
    cache.add(new_state)
    return new_state
```

### å†…å­˜æ¸…ç†
```python
# è‡ªåŠ¨è°ƒç”¨LeanæœåŠ¡å™¨æ¸…ç†å‘½ä»¤
lean_server.run(RemoveProofState(remove_proof_state=state_id))
```

## å…¼å®¹æ€§

- âœ… **å‘åå…¼å®¹**: ç°æœ‰ä»£ç æ— éœ€ä¿®æ”¹
- âœ… **é€æ˜é›†æˆ**: å†…å­˜ç®¡ç†å®Œå…¨é€æ˜
- âœ… **æ€§èƒ½æå‡**: é¿å…å†…å­˜æ³„æ¼ï¼Œæé«˜é•¿æœŸç¨³å®šæ€§
- âœ… **ç›‘æ§å‹å¥½**: æä¾›è¯¦ç»†çš„ç»Ÿè®¡å’Œè°ƒè¯•ä¿¡æ¯

## æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **çŠ¶æ€é‡å»ºå¤±è´¥**
   - æ£€æŸ¥çˆ¶å­å…³ç³»æ˜ å°„æ˜¯å¦æ­£ç¡®
   - ç¡®ä¿LeanæœåŠ¡å™¨å¯ç”¨
   - éªŒè¯ç”Ÿæˆç­–ç•¥çš„æœ‰æ•ˆæ€§

2. **ç¼“å­˜å‘½ä¸­ç‡ä½**
   - è€ƒè™‘å¢åŠ ç¼“å­˜å¤§å°
   - æ£€æŸ¥çŠ¶æ€è®¿é—®æ¨¡å¼
   - åˆ†ææ¸…ç†é¢‘ç‡

3. **å†…å­˜ä½¿ç”¨å¼‚å¸¸**
   - æ£€æŸ¥æ ¹çŠ¶æ€æ ‡è®°æ˜¯å¦æ­£ç¡®
   - ç›‘æ§LRUæ¸…ç†æ—¥å¿—
   - éªŒè¯RemoveProofStateè°ƒç”¨

### è°ƒè¯•ä¿¡æ¯

ç³»ç»Ÿä¼šè‡ªåŠ¨è¾“å‡ºè¯¦ç»†çš„è°ƒè¯•ä¿¡æ¯ï¼š
```
ğŸ’¾ Cache hit: state 42
ğŸ”„ Cache miss: rebuilding state 43
ğŸ§¹ LRU cleanup: removed 2 states, cache size: 18
ğŸ“Š Cache stats: 18/20 states, hit rate: 85.2%
```

## æœªæ¥æ”¹è¿›

å¯èƒ½çš„ä¼˜åŒ–æ–¹å‘ï¼š
1. **é¢„æµ‹æ€§æ¸…ç†**: åŸºäºè®¿é—®æ¨¡å¼é¢„æµ‹çŠ¶æ€ä½¿ç”¨
2. **åˆ†å±‚ç¼“å­˜**: åŒºåˆ†ä¸åŒä¼˜å…ˆçº§çš„çŠ¶æ€
3. **æŒä¹…åŒ–**: å°†çŠ¶æ€ä¿å­˜åˆ°ç£ç›˜ä»¥æ”¯æŒæ›´å¤§çš„å·¥ä½œé›†
4. **åˆ†å¸ƒå¼**: æ”¯æŒå¤šè¿›ç¨‹é—´çš„çŠ¶æ€å…±äº«